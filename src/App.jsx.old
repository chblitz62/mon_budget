import React, { useState } from 'react';
import { Plus, Trash2, Download, Building2, Users, Landmark, Settings, Calendar, TrendingUp, DollarSign } from 'lucide-react';

const BudgetTool = () => {
  const [globalParams, setGlobalParams] = useState({
    augmentationAnnuelle: 2.5
  });

  const [direction, setDirection] = useState({
    personnel: [
      { id: 1, titre: 'Directeur', etp: 1, salaire: 4500, segur: true },
      { id: 2, titre: 'Chef de Service', etp: 2, salaire: 3500, segur: true },
      { id: 3, titre: 'Secrétariat', etp: 2, salaire: 2400, segur: true },
      { id: 4, titre: 'Agent accueil', etp: 1, salaire: 2500, segur: true },
      { id: 5, titre: 'Comptable', etp: 1, salaire: 2400, segur: true }
    ],
    loyer: 2000,
    charges: 800,
    autresCharges: 500
  });

  const [lieux, setLieux] = useState([
    {
      id: 1,
      nom: 'Lieu de Vie 1',
      enfantsParLieu: 6,
      tauxRemplissage: 95,
      investissements: {
        bienImmo: { montant: 380000, duree: 30, taux: 2.5 },
        travaux: { montant: 20000, duree: 10, taux: 2.0 },
        vehicule: { montant: 55000, duree: 5, taux: 3.0 },
        informatique: { montant: 5000, duree: 3, taux: 0 },
        mobilier: { montant: 5000, duree: 10, taux: 0 },
        fraisBancaires: { montant: 15000, duree: 15, taux: 0 },
        fraisNotaire: { montant: 28000, duree: 1, taux: 0 }
      },
      exploitation: {
        alimentation: 2500,
        carburant: 1500,
        assurances: 600,
        fraisBancaires: 200,
        budgetPedago: 1500,
        eauElecGaz: 800,
        entretien: 250,
        fournitures: 300
      },
      personnel: [
        { id: 1, titre: 'Éducateur Spécialisé', etp: 2, salaire: 3000, segur: true },
        { id: 2, titre: 'Directeur', etp: 0.2, salaire: 4500, segur: true },
        { id: 3, titre: 'Chef de service', etp: 0.4, salaire: 3500, segur: true },
        { id: 4, titre: 'Agent technique', etp: 0.1, salaire: 2400, segur: true },
        { id: 5, titre: 'IDE', etp: 0.1, salaire: 3000, segur: true },
        { id: 6, titre: 'Secrétariat', etp: 0.2, salaire: 2400, segur: true }
      ]
    }
  ]);

  const CHARGES_PATRONALES = 0.42;
  const PRIME_SEGUR = 238;
  const JOURS_ANNEE = 365;

  // CALCULS
  const calculerSalaireAnnuel = (salaire, etp, segur) => {
    const salaireAnnuel = salaire * 12 * etp;
    const charges = salaireAnnuel * CHARGES_PATRONALES;
    const primeSegur = segur ? (PRIME_SEGUR * 1.42) * 12 * etp : 0;
    return {
      brut: salaireAnnuel,
      charges: charges,
      segur: primeSegur,
      total: salaireAnnuel + charges + primeSegur
    };
  };

  const calculerAmortissementEtInterets = (investissement) => {
    const { montant, duree, taux } = investissement;
    const amortissement = montant / duree;
    const interets = (montant * taux) / 100;
    return { amortissement, interets };
  };

  const calculerBudgetDirection = () => {
    const detailsSalaires = direction.personnel.map(p => ({
      titre: p.titre,
      ...calculerSalaireAnnuel(p.salaire, p.etp, p.segur)
    }));
    
    const totalSalaires = detailsSalaires.reduce((sum, s) => sum + s.total, 0);
    const chargesSiege = (direction.loyer + direction.charges + direction.autresCharges) * 12;
    
    return {
      salaires: totalSalaires,
      detailsSalaires,
      chargesSiege,
      total: totalSalaires + chargesSiege
    };
  };

  const calculerBudgetLieu = (lieu) => {
    const detailsSalaires = lieu.personnel.map(p => ({
      titre: p.titre,
      ...calculerSalaireAnnuel(p.salaire, p.etp, p.segur)
    }));
    
    const salaires = detailsSalaires.reduce((sum, s) => sum + s.total, 0);
    const exploitation = Object.values(lieu.exploitation).reduce((sum, val) => sum + val * 12, 0);
    
    let amortissements = 0;
    let interets = 0;
    const detailsInvest = {};
    
    Object.entries(lieu.investissements).forEach(([key, inv]) => {
      const calc = calculerAmortissementEtInterets(inv);
      amortissements += calc.amortissement;
      interets += calc.interets;
      detailsInvest[key] = calc;
    });

    const joursAnnuels = lieu.enfantsParLieu * (lieu.tauxRemplissage / 100) * JOURS_ANNEE;
    const totalAvantAmort = salaires + exploitation + interets;
    const total = totalAvantAmort + amortissements;
    const prixJour = joursAnnuels > 0 ? total / joursAnnuels : 0;

    return {
      salaires,
      detailsSalaires,
      exploitation,
      amortissements,
      interets,
      detailsInvest,
      joursAnnuels,
      total,
      prixJour
    };
  };

  const summary3Ans = [1, 2, 3].map(annee => {
    const augmentation = Math.pow(1 + globalParams.augmentationAnnuelle / 100, annee - 1);
    const budgetDir = calculerBudgetDirection();
    const budgetDirAjuste = (budgetDir.salaires + budgetDir.chargesSiege) * augmentation;
    
    let totalGlobal = budgetDirAjuste;
    let totalJours = 0;
    let amortTotal = 0;
    let interetsTotal = 0;
    let detailsLieux = [];

    lieux.forEach(l => {
      const bLieu = calculerBudgetLieu(l);
      const budgetLieuAjuste = (bLieu.salaires + bLieu.exploitation + bLieu.interets) * augmentation;
      totalGlobal += budgetLieuAjuste + bLieu.amortissements;
      totalJours += bLieu.joursAnnuels;
      amortTotal += bLieu.amortissements;
      interetsTotal += bLieu.interets * augmentation;
      
      detailsLieux.push({
        nom: l.nom,
        budget: budgetLieuAjuste + bLieu.amortissements,
        jours: bLieu.joursAnnuels,
        prixJour: bLieu.joursAnnuels > 0 ? (budgetLieuAjuste + bLieu.amortissements) / bLieu.joursAnnuels : 0
      });
    });

    return {
      annee,
      total: totalGlobal,
      prixJour: totalJours > 0 ? totalGlobal / totalJours : 0,
      amortissements: amortTotal,
      interets: interetsTotal,
      jours: totalJours,
      detailsLieux
    };
  });

  // EXPORT EXCEL
  const exporterExcel = () => {
    let csv = '\uFEFF';
    csv += 'BUDGET PRÉVISIONNEL - PROTECTION DE L\'ENFANCE\n';
    csv += `Date d'édition: ${new Date().toLocaleDateString('fr-FR')}\n\n`;
    
    csv += '═══════════════════════════════════════════════════════════════════\n';
    csv += 'SYNTHÈSE BUDGÉTAIRE SUR 3 ANS\n';
    csv += '═══════════════════════════════════════════════════════════════════\n\n';
    csv += 'Année,Budget Total (€),Amortissements (€),Intérêts (€),Jours,Prix de Journée Moyen (€)\n';
    summary3Ans.forEach(s => {
      csv += `${s.annee},${s.total.toFixed(2)},${s.amortissements.toFixed(2)},${s.interets.toFixed(2)},${s.jours.toFixed(0)},${s.prixJour.toFixed(2)}\n`;
    });
    
    csv += '\n\n═══════════════════════════════════════════════════════════════════\n';
    csv += 'DÉTAIL PAR LIEU DE VIE - ANNÉE 1\n';
    csv += '═══════════════════════════════════════════════════════════════════\n\n';
    summary3Ans[0].detailsLieux.forEach(lieu => {
      csv += `${lieu.nom},Budget: ${lieu.budget.toFixed(2)} €,Jours: ${lieu.jours.toFixed(0)},Prix/jour: ${lieu.prixJour.toFixed(2)} €\n`;
    });
    
    csv += '\n\n═══════════════════════════════════════════════════════════════════\n';
    csv += 'BUDGET DIRECTION & SIÈGE - ANNÉE 1\n';
    csv += '═══════════════════════════════════════════════════════════════════\n\n';
    const budgetDir = calculerBudgetDirection();
    csv += 'Poste,ETP,Salaire Brut Mensuel,Salaire Brut Annuel,Charges Patronales,Prime Ségur,Total Annuel\n';
    budgetDir.detailsSalaires.forEach(s => {
      const p = direction.personnel.find(per => per.titre === s.titre);
      csv += `${s.titre},${p.etp},${p.salaire},${s.brut.toFixed(2)},${s.charges.toFixed(2)},${s.segur.toFixed(2)},${s.total.toFixed(2)}\n`;
    });
    csv += `\nLoyer mensuel,${direction.loyer}\n`;
    csv += `Charges mensuelles,${direction.charges}\n`;
    csv += `Autres charges mensuelles,${direction.autresCharges}\n`;
    csv += `Total charges siège annuel,${budgetDir.chargesSiege.toFixed(2)}\n`;
    csv += `\nTOTAL DIRECTION,${budgetDir.total.toFixed(2)}\n`;
    
    lieux.forEach((lieu, idx) => {
      const bLieu = calculerBudgetLieu(lieu);
      csv += `\n\n═══════════════════════════════════════════════════════════════════\n`;
      csv += `${lieu.nom.toUpperCase()} - DÉTAIL COMPLET\n`;
      csv += '═══════════════════════════════════════════════════════════════════\n\n';
      
      csv += `Paramètres:\n`;
      csv += `Nombre d'enfants,${lieu.enfantsParLieu}\n`;
      csv += `Taux d'occupation,%${lieu.tauxRemplissage}\n`;
      csv += `Jours annuels,${bLieu.joursAnnuels.toFixed(0)}\n\n`;
      
      csv += 'PERSONNEL\n';
      csv += 'Poste,ETP,Salaire Mensuel,Salaire Annuel Brut,Charges Patronales,Prime Ségur,Total Annuel\n';
      bLieu.detailsSalaires.forEach(s => {
        const p = lieu.personnel.find(per => per.titre === s.titre);
        csv += `${s.titre},${p.etp},${p.salaire},${s.brut.toFixed(2)},${s.charges.toFixed(2)},${s.segur.toFixed(2)},${s.total.toFixed(2)}\n`;
      });
      csv += `Total masse salariale,${bLieu.salaires.toFixed(2)}\n\n`;
      
      csv += 'CHARGES D\'EXPLOITATION (MENSUELLES)\n';
      csv += 'Poste,Montant Mensuel,Montant Annuel\n';
      Object.entries(lieu.exploitation).forEach(([key, val]) => {
        csv += `${key},${val},${(val * 12).toFixed(2)}\n`;
      });
      csv += `Total exploitation,${bLieu.exploitation.toFixed(2)}\n\n`;
      
      csv += 'INVESTISSEMENTS & AMORTISSEMENTS\n';
      csv += 'Poste,Montant,Durée (ans),Taux (%),Amortissement Annuel,Intérêts Annuels\n';
      Object.entries(lieu.investissements).forEach(([key, inv]) => {
        const calc = bLieu.detailsInvest[key];
        csv += `${key},${inv.montant},${inv.duree},${inv.taux},${calc.amortissement.toFixed(2)},${calc.interets.toFixed(2)}\n`;
      });
      csv += `Total amortissements,${bLieu.amortissements.toFixed(2)}\n`;
      csv += `Total intérêts,${bLieu.interets.toFixed(2)}\n\n`;
      
      csv += `SYNTHÈSE ${lieu.nom}\n`;
      csv += `Salaires,${bLieu.salaires.toFixed(2)}\n`;
      csv += `Exploitation,${bLieu.exploitation.toFixed(2)}\n`;
      csv += `Intérêts,${bLieu.interets.toFixed(2)}\n`;
      csv += `Amortissements,${bLieu.amortissements.toFixed(2)}\n`;
      csv += `TOTAL,${bLieu.total.toFixed(2)}\n`;
      csv += `Prix de journée,${bLieu.prixJour.toFixed(2)}\n`;
    });
    
    csv += '\n\n═══════════════════════════════════════════════════════════════════\n';
    csv += 'COMPTE DE RÉSULTAT PRÉVISIONNEL\n';
    csv += '═══════════════════════════════════════════════════════════════════\n\n';
    csv += 'Poste,Année 1,Année 2,Année 3\n';
    
    const comptes = {
      'PRODUITS D\'EXPLOITATION': [],
      'Total Produits': [],
      '': [],
      'CHARGES D\'EXPLOITATION': [],
      'Salaires et traitements': [],
      'Charges sociales': [],
      'Autres charges externes': [],
      'Dotations aux amortissements': [],
      'Charges financières (intérêts)': [],
      'Total Charges': [],
      ' ': [],
      'RÉSULTAT D\'EXPLOITATION': []
    };
    
    summary3Ans.forEach((s, i) => {
      const produits = s.total - s.amortissements;
      comptes['PRODUITS D\'EXPLOITATION'][i] = produits.toFixed(2);
      comptes['Total Produits'][i] = produits.toFixed(2);
      comptes[''][i] = '';
      comptes['CHARGES D\'EXPLOITATION'][i] = '';
      
      const budgetDir = calculerBudgetDirection();
      let totalSalaires = budgetDir.salaires;
      let totalCharges = 0;
      
      lieux.forEach(l => {
        const b = calculerBudgetLieu(l);
        totalSalaires += b.salaires;
        totalCharges += b.exploitation;
      });
      
      const augmentation = Math.pow(1 + globalParams.augmentationAnnuelle / 100, i);
      const salairesBruts = totalSalaires / 1.42;
      const chargesSociales = totalSalaires - salairesBruts;
      
      comptes['Salaires et traitements'][i] = (salairesBruts * augmentation).toFixed(2);
      comptes['Charges sociales'][i] = (chargesSociales * augmentation).toFixed(2);
      comptes['Autres charges externes'][i] = ((totalCharges + budgetDir.chargesSiege) * augmentation).toFixed(2);
      comptes['Dotations aux amortissements'][i] = s.amortissements.toFixed(2);
      comptes['Charges financières (intérêts)'][i] = s.interets.toFixed(2);
      comptes['Total Charges'][i] = s.total.toFixed(2);
      comptes[' '][i] = '';
      comptes['RÉSULTAT D\'EXPLOITATION'][i] = (produits - s.total).toFixed(2);
    });
    
    Object.entries(comptes).forEach(([key, values]) => {
      csv += `${key},${values[0] || ''},${values[1] || ''},${values[2] || ''}\n`;
    });
    
    csv += '\n\nNotes:\n';
    csv += '- Charges patronales: 42%\n';
    csv += '- Prime Ségur: 238€/mois (si applicable)\n';
    csv += `- Taux d'augmentation annuel: ${globalParams.augmentationAnnuelle}%\n`;
    csv += '- Les amortissements sont calculés en linéaire\n';
    csv += '- Les intérêts sont calculés sur le capital restant dû\n';
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `budget_previsionnel_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-indigo-50 p-4 md:p-8">
      <div className="max-w-7xl mx-auto">
        
        {/* En-tête */}
        <div className="bg-white rounded-3xl shadow-lg border p-6 mb-6">
          <div className="flex flex-wrap justify-between items-center gap-4">
            <div>
              <h1 className="text-3xl font-black text-slate-800">Budget Prévisionnel</h1>
              <p className="text-slate-500 text-sm">Protection de l'Enfance - Projection sur 3 ans</p>
            </div>
            <div className="flex gap-3 items-center">
              <div className="bg-emerald-50 px-4 py-2 rounded-xl border border-emerald-200">
                <span className="text-xs font-bold text-emerald-600 uppercase">Augmentation annuelle</span>
                <div className="flex items-center gap-2">
                  <input 
                    type="number"
                    step="0.1"
                    className="bg-transparent font-black text-xl text-emerald-700 outline-none w-16"
                    value={globalParams.augmentationAnnuelle}
                    onChange={(e) => setGlobalParams({...globalParams, augmentationAnnuelle: parseFloat(e.target.value) || 0})}
                  />
                  <TrendingUp className="text-emerald-400" size={20} />
                </div>
              </div>
              <button 
                onClick={exporterExcel} 
                className="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:shadow-xl transition-all"
              >
                <Download size={18} /> EXPORT EXCEL
              </button>
            </div>
          </div>
        </div>

        {/* Récapitulatif 3 ans */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          {summary3Ans.map(s => (
            <div key={s.annee} className="bg-gradient-to-br from-white to-indigo-50 p-6 rounded-3xl shadow-lg border-2 border-indigo-200">
              <div className="flex justify-between items-center mb-3">
                <span className="text-xs font-black text-indigo-400 uppercase tracking-wider">Année {s.annee}</span>
                <Calendar className="text-indigo-300" size={20} />
              </div>
              <div className="text-3xl font-black text-slate-800 mb-1">
                {Math.round(s.prixJour)} € <span className="text-base font-medium text-slate-400">/ jour</span>
              </div>
              <div className="text-sm text-slate-600 space-y-1">
                <div className="flex justify-between">
                  <span>Budget:</span>
                  <span className="font-bold">{Math.round(s.total).toLocaleString()} €</span>
                </div>
                <div className="flex justify-between text-xs">
                  <span>Jours:</span>
                  <span className="font-bold">{Math.round(s.jours).toLocaleString()}</span>
                </div>
              </div>
              <div className="mt-3 pt-3 border-t border-indigo-100 space-y-1 text-xs">
                {s.detailsLieux.map(l => (
                  <div key={l.nom} className="flex justify-between text-slate-500">
                    <span>{l.nom}:</span>
                    <span className="font-bold">{Math.round(l.prixJour)} €/j</span>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>

        {/* Direction & Siège */}
        <div className="bg-gradient-to-br from-indigo-900 to-indigo-800 text-white rounded-3xl p-8 mb-8 shadow-xl">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-black flex items-center gap-3">
              <Building2 className="text-indigo-400" size={28} /> Direction & Siège
            </h2>
            <div className="flex gap-2">
              <button 
                onClick={() => setDirection({...direction, personnel: [...direction.personnel, { id: Date.now(), titre: 'Nouveau poste', etp: 1, salaire: 2500, segur: true }]})}
                className="bg-white/20 p-2 rounded-xl hover:bg-white/30 transition-all"
              >
                <Plus size={20} />
              </button>
            </div>
          </div>

          {/* Charges siège */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div className="bg-white/10 p-4 rounded-2xl backdrop-blur-sm">
              <label className="text-xs font-bold text-indigo-300 uppercase block mb-2">Loyer mensuel</label>
              <div className="flex items-center gap-2">
                <input 
                  type="number"
                  className="bg-white/20 text-white font-bold text-lg px-3 py-2 rounded-lg w-full outline-none"
                  value={direction.loyer}
                  onChange={(e) => setDirection({...direction, loyer: parseInt(e.target.value) || 0})}
                />
                <DollarSign className="text-indigo-300" size={20} />
              </div>
            </div>
            <div className="bg-white/10 p-4 rounded-2xl backdrop-blur-sm">
              <label className="text-xs font-bold text-indigo-300 uppercase block mb-2">Charges mensuelles</label>
              <div className="flex items-center gap-2">
                <input 
                  type="number"
                  className="bg-white/20 text-white font-bold text-lg px-3 py-2 rounded-lg w-full outline-none"
                  value={direction.charges}
                  onChange={(e) => setDirection({...direction, charges: parseInt(e.target.value) || 0})}
                />
                <DollarSign className="text-indigo-300" size={20} />
              </div>
            </div>
            <div className="bg-white/10 p-4 rounded-2xl backdrop-blur-sm">
              <label className="text-xs font-bold text-indigo-300 uppercase block mb-2">Autres charges</label>
              <div className="flex items-center gap-2">
                <input 
                  type="number"
                  className="bg-white/20 text-white font-bold text-lg px-3 py-2 rounded-lg w-full outline-none"
                  value={direction.autresCharges}
                  onChange={(e) => setDirection({...direction, autresCharges: parseInt(e.target.value) || 0})}
                />
                <DollarSign className="text-indigo-300" size={20} />
              </div>
            </div>
          </div>

          {/* Personnel direction */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
            {direction.personnel.map(p => (
              <div key={p.id} className="bg-white/10 p-4 rounded-2xl relative group border border-white/5 backdrop-blur-sm hover:bg-white/15 transition-all">
                <button 
                  onClick={() => setDirection({...direction, personnel: direction.personnel.filter(per => per.id !== p.id)})}
                  className="absolute -top-2 -right-2 bg-red-500 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-lg"
                >
                  <Trash2 size={14} />
                </button>
                <input 
                  className="bg-transparent font-bold text-sm border-b border-white/30 w-full mb-3 outline-none pb-1"
                  value={p.titre}
                  onChange={(e) => setDirection({...direction, personnel: direction.personnel.map(per => per.id === p.id ? {...per, titre: e.target.value} : per)})}
                />
                <div className="text-xs space-y-2 opacity-90">
                  <div className="flex justify-between items-center">
                    <span>ETP:</span>
                    <input 
                      type="number" 
                      step="0.1" 
                      className="bg-white/20 w-16 rounded px-2 py-1 text-center font-bold" 
                      value={p.etp} 
                      onChange={(e) => setDirection({...direction, personnel: direction.personnel.map(per => per.id === p.id ? {...per, etp: parseFloat(e.target.value) || 0} : per)})}
                    />
                  </div>
                  <div className="flex justify-between items-center">
                    <span>Salaire:</span>
                    <input 
                      type="number" 
                      className="bg-white/20 w-20 rounded px-2 py-1 text-center font-bold" 
                      value={p.salaire} 
                      onChange={(e) => setDirection({...direction, personnel: direction.personnel.map(per => per.id === p.id ? {...per, salaire: parseInt(e.target.value) || 0} : per)})}
                    />
                  </div>
                  <div className="flex justify-between items-center">
                    <span>Ségur:</span>
                    <input 
                      type="checkbox" 
                      className="w-4 h-4 rounded" 
                      checked={p.segur} 
                      onChange={(e) => setDirection({...direction, personnel: direction.personnel.map(per => per.id === p.id ? {...per, segur: e.target.checked} : per)})}
                    />
                  </div>
                </div>
              </div>
            ))}
          </div>
          
          <div className="mt-6 pt-6 border-t border-white/20">
            <div className="text-right">
              <span className="text-sm text-indigo-300">Budget Direction Annuel:</span>
              <span className="text-2xl font-black ml-3">{Math.round(calculerBudgetDirection().total).toLocaleString()} €</span>
            </div>
          </div>
        </div>

        {/* Lieux de vie */}
        <div className="space-y-8">
          {lieux.map(lieu => {
            const budgetLieu = calculerBudgetLieu(lieu);
            return (
              <div key={lieu.id} className="bg-white rounded-3xl shadow-lg border-2 border-slate-100 p-8 hover:shadow-xl transition-all">
                <div className="flex flex-wrap justify-between items-center mb-8 gap-4">
                  <div className="flex items-center gap-4">
                    <input 
                      className="text-2xl font-black text-slate-800 outline-none border-b-2 border-transparent focus:border-indigo-500 transition-all"
                      value={lieu.nom}
                      onChange={(e) => setLieux(lieux.map(l => l.id === lieu.id ? {...l, nom: e.target.value} : l))}
                    />
                    <div className="flex gap-2">
                      <span className="bg-emerald-100 text-emerald-700 px-4 py-2 rounded-xl text-sm font-bold shadow-sm">
                        {Math.round(budgetLieu.prixJour)} € / jour
                      </span>
                      <span className="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-xl text-sm font-bold shadow-sm">
                        {Math.round(budgetLieu.total).toLocaleString()} € / an
                      </span>
                    </div>
                  </div>
                  <button 
                    onClick={() => setLieux(lieux.filter(l => l.id !== lieu.id))}
                    className="text-red-400 p-2 hover:bg-red-50 rounded-xl transition-all"
                  >
                    <Trash2 size={22} />
                  </button>
                </div>

                {/* Paramètres du lieu */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                  <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-2xl border border-blue-200">
                    <label className="text-xs font-black text-blue-600 uppercase block mb-2">Nombre d'enfants</label>
                    <input 
                      type="number"
                      className="bg-white text-blue-700 font-black text-2xl px-4 py-2 rounded-xl w-full outline-none shadow-sm"
                      value={lieu.enfantsParLieu}
                      onChange={(e) => setLieux(lieux.map(l => l.id === lieu.id ? {...l, enfantsParLieu: parseInt(e.target.value) || 0} : l))}
                    />
                  </div>
                  <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-2xl border border-purple-200">
                    <label className="text-xs font-black text-purple-600 uppercase block mb-2">Taux d'occupation (%)</label>
                    <input 
                      type="number"
                      className="bg-white text-purple-700 font-black text-2xl px-4 py-2 rounded-xl w-full outline-none shadow-sm"
                      value={lieu.tauxRemplissage}
                      onChange={(e) => setLieux(lieux.map(l => l.id === lieu.id ? {...l, tauxRemplissage: parseFloat(e.target.value) || 0} : l))}
                    />
                  </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  {/* Investissements */}
                  <div className="bg-gradient-to-br from-slate-50 to-slate-100 p-6 rounded-3xl border border-slate-200">
                    <h3 className="text-sm font-black text-slate-600 uppercase mb-4 flex items-center gap-2">
                      <Landmark size={18} className="text-slate-400" /> Investissements & Prêts
                    </h3>
                    <div className="space-y-4">
                      {Object.entries(lieu.investissements).map(([key, inv]) => (
                        <div key={key} className="bg-white p-3 rounded-2xl shadow-sm border border-slate-100">
                          <div className="text-xs font-bold text-slate-700 uppercase mb-2">{key.replace(/([A-Z])/g, ' $1')}</div>
                          <div className="grid grid-cols-3 gap-2">
                            <div>
                              <label className="text-[9px] text-slate-500 block">Montant</label>
                              <input 
                                type="number"
                                className="w-full text-xs font-bold bg-slate-50 rounded px-2 py-1 outline-none"
                                value={inv.montant}
                                onChange={(e) => setLieux(lieux.map(l => l.id === lieu.id ? { ...l, investissements: {...l.investissements, [key]: {...inv, montant: parseInt(e.target.value) || 0}}} : l))}
                              />
                            </div>
                            <div>
                              <label className="text-[9px] text-slate-500 block">Durée (ans)</label>
                              <input 
                                type="number"
                                className="w-full text-xs font-bold bg-slate-50 rounded px-2 py-1 outline-none"
                                value={inv.duree}
                                onChange={(e) => setLieux(lieux.map(l => l.id === lieu.id ? { ...l, investissements: {...l.investissements, [key]: {...inv, duree: parseInt(e.target.value) || 0}}} : l))}
                              />
                            </div>
                            <div>
                              <label className="text-[9px] text-slate-500 block">Taux %</label>
                              <input 
                                type="number"
                                step="0.1"
                                className="w-full text-xs font-bold bg-slate-50 rounded px-2 py-1 outline-none"
                                value={inv.taux}
                                onChange={(e) => setLieux(lieux.map(l => l.id === lieu.id ? { ...l, investissements: {...l.investissements, [key]: {...inv, taux: parseFloat(e.target.value) || 0}}} : l))}
                              />
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                    <div className="mt-4 pt-4 border-t border-slate-200">
                      <div className="flex justify-between text-xs font-bold">
                        <span className="text-slate-600">Amortissements/an:</span>
                        <span className="text-slate-800">{Math.round(budgetLieu.amortissements).toLocaleString()} €</span>
                      </div>
                      <div className="flex justify-between text-xs font-bold mt-1">
                        <span className="text-slate-600">Intérêts/an:</span>
                        <span className="text-red-600">{Math.round(budgetLieu.interets).toLocaleString()} €</span>
                      </div>
                    </div>
                  </div>

                  {/* Exploitation */}
                  <div className="bg-gradient-to-br from-emerald-50 to-teal-50 p-6 rounded-3xl border border-emerald-200">
                    <h3 className="text-sm font-black text-emerald-700 uppercase mb-4 flex items-center gap-2">
                      <Settings size={18} /> Exploitation
                    </h3>
                    <div className="space-y-3">
                      {Object.entries(lieu.exploitation).map(([key, val]) => (
                        <div key={key} className="flex justify-between items-center bg-white p-2 rounded-xl shadow-sm">
                          <span className="text-xs font-bold text-slate-600 capitalize">{key}</span>
                          <input 
                            type="number"
                            className="w-24 text-right text-xs font-black bg-emerald-50 rounded-lg px-2 py-1 outline-none"
                            value={val}
                            onChange={(e) => setLieux(lieux.map(l => l.id === lieu.id ? { ...l, exploitation: {...l.exploitation, [key]: parseInt(e.target.value) || 0}} : l))}
                          />
                        </div>
                      ))}
                    </div>
                    <div className="mt-4 pt-4 border-t border-emerald-200">
                      <div className="flex justify-between text-sm font-bold">
                        <span className="text-emerald-700">Total/an:</span>
                        <span className="text-emerald-800">{Math.round(budgetLieu.exploitation).toLocaleString()} €</span>
                      </div>
                    </div>
                  </div>

                  {/* Personnel */}
                  <div className="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-3xl border border-indigo-200">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-sm font-black text-indigo-700 uppercase flex items-center gap-2">
                        <Users size={18} /> Équipe
                      </h3>
                      <button 
                        onClick={() => setLieux(lieux.map(l => l.id === lieu.id ? { ...l, personnel: [...l.personnel, { id: Date.now(), titre: 'Nouveau', etp: 1, salaire: 2000, segur: true }]} : l))}
                        className="bg-indigo-600 text-white p-1.5 rounded-lg hover:bg-indigo-700 transition-all shadow-sm"
                      >
                        <Plus size={16} />
                      </button>
                    </div>
                    <div className="space-y-3 overflow-y-auto max-h-[400px] pr-2">
                      {lieu.personnel.map(p => (
                        <div key={p.id} className="bg-white p-3 rounded-xl shadow-sm border border-indigo-100 group relative hover:shadow-md transition-all">
                          <button 
                            onClick={() => setLieux(lieux.map(l => l.id === lieu.id ? {...l, personnel: l.personnel.filter(per => per.id !== p.id)} : l))}
                            className="absolute -top-1 -right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                          >
                            <Trash2 size={10} />
                          </button>
                          <input 
                            className="font-bold text-sm w-full mb-2 outline-none border-b border-indigo-100 pb-1" 
                            value={p.titre} 
                            onChange={(e) => setLieux(lieux.map(l => l.id === lieu.id ? {...l, personnel: l.personnel.map(per => per.id === p.id ? {...per, titre: e.target.value} : per)} : l))}
                          />
                          <div className="grid grid-cols-2 gap-2 text-xs">
                            <div>
                              <label className="text-[9px] text-slate-500 block">ETP</label>
                              <input 
                                type="number" 
                                step="0.1" 
                                className="w-full bg-indigo-50 rounded px-2 py-1 font-bold" 
                                value={p.etp} 
                                onChange={(e) => setLieux(lieux.map(l => l.id === lieu.id ? {...l, personnel: l.personnel.map(per => per.id === p.id ? {...per, etp: parseFloat(e.target.value) || 0} : per)} : l))}
                              />
                            </div>
                            <div>
                              <label className="text-[9px] text-slate-500 block">Salaire</label>
                              <input 
                                type="number" 
                                className="w-full bg-indigo-50 rounded px-2 py-1 font-bold" 
                                value={p.salaire} 
                                onChange={(e) => setLieux(lieux.map(l => l.id === lieu.id ? {...l, personnel: l.personnel.map(per => per.id === p.id ? {...per, salaire: parseInt(e.target.value) || 0} : per)} : l))}
                              />
                            </div>
                          </div>
                          <div className="mt-2 flex items-center justify-between text-xs">
                            <span className="text-slate-500">Prime Ségur</span>
                            <input 
                              type="checkbox" 
                              className="w-4 h-4 rounded" 
                              checked={p.segur} 
                              onChange={(e) => setLieux(lieux.map(l => l.id === lieu.id ? {...l, personnel: l.personnel.map(per => per.id === p.id ? {...per, segur: e.target.checked} : per)} : l))}
                            />
                          </div>
                        </div>
                      ))}
                    </div>
                    <div className="mt-4 pt-4 border-t border-indigo-200">
                      <div className="flex justify-between text-sm font-bold">
                        <span className="text-indigo-700">Masse salariale:</span>
                        <span className="text-indigo-800">{Math.round(budgetLieu.salaires).toLocaleString()} €</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
        
        <button 
          onClick={() => {
            const nouveauLieu = {
              ...lieux[0],
              id: Date.now(),
              nom: `Lieu de Vie ${lieux.length + 1}`,
              personnel: lieux[0].personnel.map(p => ({...p, id: Date.now() + Math.random()}))
            };
            setLieux([...lieux, nouveauLieu]);
          }}
          className="w-full mt-8 py-5 border-2 border-dashed border-indigo-300 rounded-3xl text-indigo-500 font-black text-lg hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 hover:border-indigo-400 transition-all flex items-center justify-center gap-3 shadow-sm"
        >
          <Plus size={24} /> AJOUTER UN NOUVEAU LIEU DE VIE
        </button>
      </div>
    </div>
  );
};

export default BudgetTool;
